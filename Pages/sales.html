<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LedgerLive | Sales</title>
  <link rel="stylesheet" href="ledgerlive-style.css">
</head>
<body>
  <aside class="sidebar">
    <div class="logo">LedgerLive</div>
    <ul>
      <li onclick="location.href='dashboard.html'">üìä Dashboard</li>
      <li class="active" onclick="location.href='sales.html'">üí∞ Sales</li>
      <li onclick="location.href='inventory.html'">üì¶ Inventory</li>
      <li onclick="location.href='suppliers.html'">üöö Suppliers</li>
      <li onclick="location.href='reports.html'">üìë Reports</li>
      <li onclick="location.href='settings.html'">‚öôÔ∏è Settings</li>
    </ul>
  </aside>

  <main class="main">
    <h1>üí∞ Sales Entry</h1>

    <div class="transaction-card">
      <label>Product</label>
      <select id="productSelect"></select>

      <label>Quantity</label>
      <input type="number" id="saleQty" min="1">

      <label>Price (‚Çπ)</label>
      <input type="number" id="salePrice" min="0">

      <label>Payment Method</label>
      <select id="paymentMethod">
        <option value="online">Online</option>
        <option value="offline">Offline</option>
      </select>

      <button onclick="processSale()">Add Sale</button>
    </div>

    <div class="table-card">
      <h3>Sales History</h3>
      <table id="salesTable">
        <thead>
          <tr>
            <th>Product</th>
            <th>Qty</th>
            <th>Price</th>
            <th>Payment</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

 <script>
  // === Load Inventory Data ===
  const inventory = JSON.parse(localStorage.getItem("dynamicInventory") || "[]");
  const productSelect = document.getElementById("productSelect");
  const salesTableBody = document.querySelector("#salesTable tbody");

  // Populate product dropdown
  inventory.forEach(item => {
    const keys = Object.keys(item);
    if (keys.length > 0) {
      const productName = item[keys[0]];
      const opt = document.createElement("option");
      opt.value = productName;
      opt.textContent = productName;
      productSelect.appendChild(opt);
    }
  });

  // === Add Two More Columns in Header ===
  const tableHead = document.querySelector("#salesTable thead tr");
  const headerTitles = ["Discount (%)", "Tax (%)", "Total (‚Çπ)"];
  headerTitles.forEach(title => {
    const th = document.createElement("th");
    th.textContent = title;
    tableHead.appendChild(th);
  });

  // === Create Total Summary Row ===
  const totalRow = document.createElement("tr");
  totalRow.id = "totalRow";
  totalRow.innerHTML = `<td colspan="6" style="text-align:right;font-weight:600;">Grand Total:</td><td id="grandTotal">‚Çπ0</td><td></td>`;
  salesTableBody.appendChild(totalRow);

  // === Process Sale ===
  function processSale() {
    const name = productSelect.value;
    const qty = parseFloat(document.getElementById("saleQty").value);
    const price = parseFloat(document.getElementById("salePrice").value);
    const payment = document.getElementById("paymentMethod").value;

    let discount = prompt("Enter discount % (if applicable, else 0):", "0");
    let tax = prompt("Enter tax % (if applicable, else 0):", "0");
    discount = parseFloat(discount) || 0;
    tax = parseFloat(tax) || 0;

    if (!name || isNaN(qty) || isNaN(price)) {
      alert("Please fill in all fields correctly.");
      return;
    }

    // === Calculate Total ===
    const subtotal = qty * price;
    const discounted = subtotal - (subtotal * discount) / 100;
    const finalTotal = discounted + (discounted * tax) / 100;

    // === Add Row ===
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${name}</td>
      <td>${qty}</td>
      <td>‚Çπ${price.toFixed(2)}</td>
      <td>${payment}</td>
      <td>${discount}%</td>
      <td>${tax}%</td>
      <td>‚Çπ${finalTotal.toFixed(2)}</td>
    `;
    salesTableBody.insertBefore(row, totalRow);

    // === Update Grand Total ===
    updateGrandTotal();

    // === Update Inventory ===
    const inv = JSON.parse(localStorage.getItem("dynamicInventory") || "[]");
    const item = inv.find(i => Object.values(i).includes(name));
    if (item) 
    {
      const qtyKey = Object.keys(item).find(k => k.toLowerCase().includes("qty"));
      if (qtyKey) 
      {
        item[qtyKey] = Math.max(0, (parseFloat(item[qtyKey]) || 0) - qty);
        localStorage.setItem("dynamicInventory", JSON.stringify(inv));
      }
    }

    // === Save Sale to LocalStorage for Dashboard ===
    const salesData = JSON.parse(localStorage.getItem("salesData") || "[]");
    salesData.push({ product: name, qty, price, payment, discount, tax, total: finalTotal });
    localStorage.setItem("salesData", JSON.stringify(salesData));
    localStorage.setItem("salesData_lastUpdate", Date.now());
  }

    function updateGrandTotal() 
    {
      let total = 0;
      const rows = salesTableBody.querySelectorAll("tr:not(#totalRow)");
      rows.forEach(r => {
        const totalCell = r.cells[r.cells.length - 1]; // last cell in the row
        if (totalCell && totalCell.textContent.includes("‚Çπ")) {
          total += parseFloat(totalCell.textContent.replace("‚Çπ", "")) || 0;
        }
      });
      document.getElementById("grandTotal").textContent = "‚Çπ" + total.toFixed(2);
    }

</script>

</body>
</html>
